!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ArRTC=t():e.ArRTC=t()}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e){e.exports=JSON.parse('{"name":"ar-rtc-miniapp","version":"0.0.1","description":"For publishing npm package anyrtc SDK (WeChat). Get more information from https://www.anyrtc.io.","main":"./release/ArRTCMiniapp@latest.js","scripts":{"build":"webpack --mode=production","dev":"webpack --mode=development","doc":"tsc & api-extractor run"},"typings":"./release/ar-rtc-miniapp.d.ts","author":"https://www.anyrtc.io","keywords":["webrtc","ArRTC"],"license":"./LICENSES","devDependencies":{"@babel/polyfill":"^7.10.4","awesome-typescript-loader":"^5.2.1","typescript":"^4.0.2"},"dependencies":{"@types/wechat-miniprogram":"^3.0.0"}}')},function(e,t,n){e.exports=n(2)},function(e,t,n){"use strict";n.r(t),n.d(t,"client",(function(){return I}));var r,o,i,s={SDK_VERSION:n(0).version,GATEWAY_ADDRESS:"https://wtgw.agrtc.cn",GATEWAY_CONNECT_TIMEOUT:2e3,GATEWAY_ERTRY_TIMEOUT:12e5,EVENT_REPORT_DOMAIN:"event.agrtc.cn",EVENT_REPORT_BACKUP_DOMAIN:"event.agrtc.cn",UPLOAD_LOG:!1,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:1e3},a=Array.prototype,u=function(){function e(){this._events={},this.addListener=this.on}return e.prototype.getListeners=function(e){return this._events[e]?a.map.call(this._events[e],(function(e){return e.listener})):[]},e.prototype.on=function(e,t){this._events[e]||(this._events[e]=[]);var n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!1})},e.prototype.once=function(e,t){this._events[e]||(this._events[e]=[]);var n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!0})},e.prototype.off=function(e,t){this._events[e]||(this._events[e]=[]);var n=this._events[e],r=this._indexOfListener(n,t);-1!==r&&a.splice.call(n,r,1)},e.prototype.removeAllListeners=function(e){e?delete this._events[e]:this._events={}},e.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this._events[e]||(this._events[e]=[]);for(var r=this._events[e],o=0;o<r.length;o+=1){var i=r[o];i.once&&this.off(e,i.listener),i.listener.apply(this,t||[])}},e.prototype._indexOfListener=function(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1},e}(),l=function(){return(l=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};o=r||(r={}),i="",o.joinGateway=function(e){return new Promise((function(t,n){i=s.GATEWAY_ADDRESS;var r="/arapi/v1?action=".concat("wapp_gateway"),o={};!function a(){return function(e,t){return new Promise((function(n){wx.request({url:i+e,data:t,method:"POST",header:{"content-type":"application/json"},complete:function(e){var t=e.statusCode;n(t?e.data:{code:-1,msg:e.errMsg})}})}))}(r,l(l({},o),e)).then((function(e){var r=e.code;e.msg,0===r?t(e):-1===r?setTimeout((function(){a()}),s.GATEWAY_CONNECT_TIMEOUT):13===r?n("DEVELOPER_INVALID"):14===r?n("UID_BANNED"):15===r?n("IP_BANNED"):16===r?n("CHANNEL_BANNED"):101===r?n("APPID_INVALID"):2002===r?n("DEVELOPER_INVALID"):109===r?n("TOKEN_EXPIRED"):110===r||setTimeout((function(){a()}),s.GATEWAY_CONNECT_TIMEOUT)}))}()}))};var c,d,h=(c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),p=function(){return(p=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},f=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},v=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},m=function(e){function t(t){var n=e.call(this)||this;n._appId="",n._serverIsWss=!0,n._serverUrl="",n._serverPort=0,n._revState="DISCONNECTED",n._curState="DISCONNECTED",n._userId=null,n._keepAiveInterval=0,n._keepAliveIntervalTime=1e4,n._handleOnline=function(){},n._connectTimeout=0,n._keepAliveTimeout=0,n.signal=null,n.handleMediaServerEvents=function(){};var r=n;return t&&t.appId&&(r._appId=t.appId),n}return h(t,e),t.prototype.setAppInfo=function(e){var t=e.appId;this._appId=t},t.prototype.configServer=function(e,t,n){this._serverIsWss=e,this._serverUrl=t,this._serverPort=n},t.prototype.connectCTS=function(){var e=this;return console.log("start ",Date.now()),new Promise((function(t,n){if(e.signal)n();else{var r=(e._serverIsWss?"wss":"ws")+"://"+e._serverUrl+":"+e._serverPort,o=wx.connectSocket({url:r});e.signal=o,e._emitConnectionState("CONNECTING"),e._setConnectTimeout(),o.onOpen((function(){console.log("open ",Date.now()),e._clearConnectTimeout(),e._emitConnectionState("CONNECTED"),t()})),o.onMessage((function(t){var n=t.data,r=JSON.parse(n),o=r.Cmd,i=(r.Encrypt,r.Content),s=JSON.parse(i);switch(o){case"KeepAlive":e._handleKeepAlive();break;case"Login":0===s.Code&&(console.log("online ",Date.now()),e._startKeepAlive(),e._handleOnline(s));break;default:e.handleMediaServerEvents&&e.handleMediaServerEvents(o,s)}})),o.onClose((function(t){var r=t.code,o=t.reason;switch(e._clearConnectTimeout(),e._stopKeepAlive(),e._removeHandleKeepAlive(),r){case 1e3:case 1005:"NETWORK_ERROR"===o?e._emitConnectionState("RECONNECTING","NETWORK_ERROR"):"UID_BANNED"===o?e._emitConnectionState("DISCONNECTED","UID_BANNED"):e._emitConnectionState("DISCONNECTED","LEAVE");break;default:e._emitConnectionState("RECONNECTING","SERVER_ERROR")}e.signal=null,n()})),o.onError((function(e){}))}}))},t.prototype.doKeepAlive=function(){var e={Cmd:"KeepAlive"};e.Content=JSON.stringify({time:Date.now().toString()}),this._sendMessage(e)},t.prototype.doJoin=function(e){return f(this,void 0,void 0,(function(){var t;return v(this,(function(n){return t=this,[2,new Promise((function(n,r){var o={Cmd:"Login"};o.AppId=t._appId,o.Content=JSON.stringify(p({},e)),t.signal.onMessage((function(e){var o=e.data,i=JSON.parse(o),s=i.Cmd,a=(i.Encrypt,i.Content),u=JSON.parse(a);if("Login"===s){var l=u.Code,c=u.UserId;0===l?(t._userId=c,n(c)):r(l)}})),t._sendMessage(o)}))]}))}))},t.prototype.doLeave=function(){var e=this;return new Promise((function(t,n){e.signal.onMessage((function(r){var o=r.data,i=JSON.parse(o),s=i.Cmd,a=(i.Encrypt,i.Content),u=JSON.parse(a);if("Logout"===s){var l=u.Code;0===l?(e._stopKeepAlive(),t()):n({code:l,reason:"Logout failure"})}}));var r={Cmd:"Logout",Content:""};e._sendMessage(r)}))},t.prototype.doPublish=function(){var e=this;return new Promise((function(t,n){e.signal.onMessage((function(e){var r=e.data,o=JSON.parse(r),i=o.Cmd,s=(o.Encrypt,o.Content),a=JSON.parse(s);if("Publish"===i){var u=a.Code,l=a.PushUrl;0===u?t({url:l}):n({code:u,reason:"publish failure"})}}));var r={Cmd:"Publish",Encrypt:!1,Content:""};e._sendMessage(r)}))},t.prototype.doUnPublish=function(){var e=this;return new Promise((function(t,n){e.signal.onMessage((function(e){var r=e.data,o=JSON.parse(r),i=o.Cmd,s=(o.Encrypt,o.Content),a=JSON.parse(s);if("UnPublish"===i){var u=a.Code;0===u?t():n({code:u,reason:"UnPublish failure"})}}));var r={Cmd:"UnPublish",Content:""};e._sendMessage(r)}))},t.prototype.doSubscribe=function(e,t){var n=this;return new Promise((function(r,o){n.signal.onMessage((function(t){var n=t.data,i=JSON.parse(n),s=i.Cmd,a=(i.Encrypt,i.Content),u=JSON.parse(a);if("Subscribe"===s){var l=u.Code,c=u.UserId,d=u.PullUrl;0===l?e===c&&r(d):o({code:l,reason:"Subscribe failure"})}}));var i={Cmd:"Subscribe"};i.Content=JSON.stringify({UserId:e,ChanId:t}),n._sendMessage(i)}))},t.prototype.doUnSubscribe=function(e,t){var n=this;return new Promise((function(r,o){n.signal.onMessage((function(e){var t=e.data,n=JSON.parse(t),i=n.Cmd,s=(n.Encrypt,n.Content),a=JSON.parse(s);if("UnSubscribe"===i){var u=a.Code;0===u?r():o({code:u,reason:"UnSubscribe failure"})}}));var i={Cmd:"UnSubscribe"};i.Content=JSON.stringify({UserId:e,ChanId:t}),n._sendMessage(i)}))},t.prototype.setClientRole=function(e){var t=this;return new Promise((function(n,r){t.signal.onMessage((function(e){var t=e.data,o=JSON.parse(t),i=o.Cmd,s=(o.Encrypt,o.Content),a=JSON.parse(s);if("SetRole"===i){var u=a.Code;0===u?n():r(u)}}));var o={Cmd:"SetRole"};o.Content=JSON.stringify({Role:e}),t._sendMessage(o)}))},t.prototype.doMuteRemoteStream=function(e,t,n){var r={Cmd:"MuteRemoteStream"};r.Content=JSON.stringify({UserId:e,MuteAudio:t,MuteVideo:n}),this._sendMessage(r)},t.prototype.doMuteLocalStream=function(e,t){var n={Cmd:"MuteLocalStream"};n.Content=JSON.stringify({UserId:this._userId,MuteAudio:e,MuteVideo:t}),this._sendMessage(n)},t.prototype.disconnectCTS=function(e){this.signal&&this.signal.close(1e3,e)},t.prototype.clearEventEmitter=function(){this.removeAllListeners()},t.prototype._setConnectTimeout=function(){var e=this;e._clearConnectTimeout(),e._connectTimeout=setTimeout((function(){e._emitConnectionState("DISCONNECTING","NETWORK_ERROR")}),1e4)},t.prototype._startKeepAlive=function(){var e=this;e._stopKeepAlive(),e.doKeepAlive(),e._keepAiveInterval=setInterval((function(){e.doKeepAlive()}),e._keepAliveIntervalTime)},t.prototype._stopKeepAlive=function(){this._keepAiveInterval&&clearInterval(this._keepAiveInterval)},t.prototype._clearConnectTimeout=function(){this._connectTimeout&&clearTimeout(this._connectTimeout)},t.prototype._handleKeepAlive=function(){var e=this;e._removeHandleKeepAlive(),e._keepAliveTimeout=setTimeout((function(){e.disconnectCTS("NETWORK_ERROR")}),3*e._keepAliveIntervalTime)},t.prototype._removeHandleKeepAlive=function(){this._keepAliveTimeout&&clearTimeout(this._keepAliveTimeout)},t.prototype._sendMessage=function(e){return"object"==typeof e&&"CONNECTED"===this._curState&&(this.signal&&this.signal.send({data:JSON.stringify(e),complete:function(e){}}),!0)},t.prototype._emitGateWayEvent=function(e,t){this.emit("@gateway_events",{type:e,data:t})},t.prototype._emitConnectionState=function(e,t){this._revState=this._curState,this._curState=e,this.handleMediaServerEvents&&this.handleMediaServerEvents("ConnectionStateChange",{curState:this._curState,revState:this._revState,reason:t}),console.log("connection state change: "+this._revState+" -> "+this._curState)},t}(u),_=function(e){var t=e;void 0===t&&(t=7);var n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?n:n+_(t-n.length)},b=function(e,t){var n="YYYY-MM-DD hh:mm:ss";if("number"!=typeof e)throw new Error("[timesToDate]: timestamp must be number");t&&"string"==typeof t&&(n=t);var r=e||Date.now(),o=new Date(r)||new Date(r),i=o.getFullYear(),s=o.getMonth()+1,a=o.getDate(),u=o.getHours(),l=o.getMinutes(),c=o.getSeconds();return n.indexOf("YYYY")>-1&&(n=n.replace("YYYY",(function(e){return""+i}))),n.indexOf("MM")>-1?n=n.replace("MM",(function(e){return s<10?"0"+s:""+s})):n.indexOf("M")>-1&&(n=n.replace("M",(function(e){return""+s}))),n.indexOf("DD")>-1?n=n.replace("DD",(function(e){return a<10?"0"+a:""+a})):n.indexOf("D")>-1&&(n=n.replace("D",(function(e){return""+a}))),n.indexOf("hh")>-1?n=n.replace("hh",(function(e){return u<10?"0"+u:""+u})):n.indexOf("h")>-1&&(n=n.replace("h",(function(e){return""+u}))),n.indexOf("mm")>-1?n=n.replace("mm",(function(e){return l<10?"0"+l:""+l})):n.indexOf("m")>-1&&(n=n.replace("m",(function(e){return""+l}))),n.indexOf("ss")>-1?n=n.replace("ss",(function(e){return c<10?"0"+c:""+c})):n.indexOf("s")>-1&&(n=n.replace("s",(function(e){return""+c}))),n};!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(d||(d={}));var y=new(function(){function e(){this.logPrefix="SupLogger",this.logLevel=d.NONE,this.uploadServeTranslators=[],this.DEBUG=d.DEBUG,this.INFO=d.INFO,this.WARNING=d.WARNING,this.ERROR=d.ERROR,this.NONE=d.NONE}return e.prototype.use=function(e){"function"==typeof e&&this.uploadServeTranslators.push((function(t,n){e(t,n)}))},e.prototype.setLogLevel=function(e,t){t&&(this.logPrefix=t),"number"==typeof e&&e>-1&&e<5&&(this.logLevel=e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>d.ERROR&&this.logLevel!==d.NONE||this.logLevel===d.NONE)){var n=e,r=Date.now();n.unshift("["+b(r,"YYYY-MM-DD hh:mm:ss")+"] %c"+this.logPrefix+" [ERROR]: ","color: #dc3545;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"error",params:n,timestamp:r},(function(){console.error.apply(console,n)}))})):console.error.apply(console,n)}},e.prototype.warning=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>d.WARNING&&this.logLevel!==d.NONE||this.logLevel===d.NONE)){var n=e,r=Date.now();n.unshift("["+b(r,"YYYY-MM-DD hh:mm:ss")+"] %c"+this.logPrefix+" [WARNING]: ","color: #ffc107;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"warning",params:n,timestamp:r},(function(){console.warn.apply(console,n)}))})):console.warn.apply(console,n)}},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>d.INFO&&this.logLevel!==d.NONE||this.logLevel===d.NONE)){var n=e,r=Date.now();n.unshift("["+b(r,"YYYY-MM-DD hh:mm:ss")+"] %c"+this.logPrefix+" [INFO]: ","color: #6facff;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"info",params:n,timestamp:r},(function(){console.log.apply(console,n)}))})):console.log.apply(console,n)}},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>d.DEBUG&&this.logLevel!==d.NONE||this.logLevel===d.NONE)){var n=e,r=Date.now();n.unshift("["+b(r,"YYYY-MM-DD hh:mm:ss")+"] %c"+this.logPrefix+" [DEBUG]: ","color: #007bff;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"debug",params:n,timestamp:r},(function(){console.log.apply(console,n)}))})):console.log.apply(console,n)}},e}());y.setLogLevel(y.DEBUG,"anyrtc-SDK");var E=y,w=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),g=function(){return(g=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},N=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},O=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},S=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},I=function(e){function t(){var t=e.call(this)||this;return t.uid="",t.role="broadcaster",t.channelName="",t.remoteUser=[],t.enableVideo=!0,t.enableAudio=!0,t._state="DISCONNECTED",t._appId="",t._sessionId="",t._joinInfo={},t._useWss=!0,t._online=!1,t._hasPublished=!1,t}return w(t,e),t.prototype.destroy=function(e,t){var n,r;"CONNECTED"===this._state&&(null===(n=this._ws)||void 0===n||n.disconnectCTS()),null===(r=this._ws)||void 0===r||r.clearEventEmitter(),this._ws=void 0,this.uid="",this.role="broadcaster",this.channelName="",this.remoteUser=[],this.enableVideo=!0,this.enableAudio=!0,this._state="",this._sessionId="",this._joinInfo={},this._online=!1,this._hasPublished=!1,e&&e()},t.prototype.init=function(e,t,n){if("string"!=typeof e||""===e)throw E.error("[init] Invalid appId"),new Error("Invalid appId");this._appId=e.trim(),t&&t()},t.prototype.join=function(e,t,n,r,o){var i;if(this._online||"CONNECTED"===this._state)throw E.error("[join] Invalid Operational, Already joined"),new Error("Invalid Operational, Already joined");if("string"!=typeof t||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw E.error("[join] Invalid channel"),new Error("Invalid channel");this.channelName=t;if(""!==n&&null!=n&&!/^[a-zA-Z0-9]{1,48}$/.test(n))throw E.error("[join] Invalid uid"),new Error("Invalid uid");e&&(this._joinInfo.token=e),this._joinInfo.sid=_(32),this._ws?null===(i=this._ws)||void 0===i||i.doJoin(this._joinInfo.content):(this._createMediaServerIntance(),this._authGateWay(n,e).then((function(e){r&&r(e)})).catch((function(e){e})))},t.prototype.leave=function(e,t){var n,r=this;"CONNECTED"===r._state&&(r._hasPublished&&r.unpublish((function(){E.debug("[leave] unpublish success!"),r._hasPublished=!1}),(function(){throw E.error("[leave] unpublish failure"),new Error("unpublish failure.")})),r.remoteUser.map((function(e){r.unsubscribe(e.uid,(function(){r.emit("stream-removed",{uid:e.uid})}),(function(){}))})),null===(n=r._ws)||void 0===n||n.doLeave().then((function(){r.role="broadcaster",r.channelName="",r.remoteUser=[],r.enableVideo=!0,r.enableAudio=!0,r._state="",r._sessionId="",r._online=!1,e&&e()})).catch((function(){t&&t()})))},t.prototype.mute=function(e,t,n,r){var o;if("string"!=typeof e||""===e)throw E.error("[mute] Invalid uid"),new Error("Invalid uid");if("video"!==t&&"audio"!==t&&"all"!==t)throw E.error("[mute] Invalid target"),new Error("Invalid target");var i=this.remoteUser.find((function(t){return t.uid===e}));if(!i)throw r&&r(),E.error("[mute] Can't find remote user"+e),new Error("Can't find remote user"+e);if(!i.hasSub)throw r&&r(),E.error("[mute] You haven't subscribed to this user's media yet"),new Error("You haven't subscribed to this user's media yet");var s=i.muteVideo,a=i.muteAudio;if(!i.hasVideo&&!i.hasAudio||"video"===t&&i.hasVideo&&s||"audio"===t&&i.hasAudio&&a||"all"===t&&s&&a)return E.error("[mute] Invalid operation, The user's ("+e+t+")  alreadly mute"),void(r&&r());switch(t){case"video":!s&&(s=!0);break;case"audio":!a&&(a=!0);break;case"all":!a&&(a=!0),!s&&(s=!0)}i.muteVideo=s,i.muteAudio=a,null===(o=this._ws)||void 0===o||o.doMuteRemoteStream(e,a,s),n&&n()},t.prototype.muteLocal=function(e,t,n){var r;if(!this._hasPublished)throw E.error("[muteLocal] You haven't published the media stream"),new Error("You haven't published the media stream.");if("video"!==e&&"audio"!==e&&"all"!==e)throw E.error("[muteLocal] Invalid target"),new Error("Invalid target");if("CONNECTED"!==this._state)throw E.error("[muteLocal] Invalid Operational, join before muteLocal please"),new Error("Invalid Operational, join before muteLocal please");if("video"===e&&!this.enableVideo||"audio"===e&&!this.enableAudio||"all"===e&&!this.enableVideo&&!this.enableAudio)n&&n();else{var o=!this.enableVideo,i=!this.enableAudio;switch(e){case"video":!o&&(o=!0);break;case"audio":!i&&(i=!0);break;case"all":!i&&(i=!0),!o&&(o=!0)}this.enableVideo=!o,this.enableAudio=!i,null===(r=this._ws)||void 0===r||r.doMuteLocalStream(i,o),t&&t()}},t.prototype.publish=function(e,t){var n,r=this;if("CONNECTED"!==r._state)throw E.error("[publish] Invalid Operational, join before publish please"),new Error("Invalid Operational, join before publish please");if(r._hasPublished)throw E.error("[publish] You already published the media stream."),new Error("You already published the media stream.");null===(n=r._ws)||void 0===n||n.doPublish().then((function(t){r._hasPublished=!0,e&&e(t.url)})).catch((function(e){r._hasPublished=!1,t&&t(e)}))},t.prototype.rejoin=function(e,t,n,r,o,i){throw new Error("Method not implemented.")},t.prototype.setRole=function(e,t,n){var r;if("CONNECTED"!==this._state)throw E.error("[setRole] Invalid Operational, join before setRole please."),new Error("Invalid Operational, join before setRole please");if("broadcaster"!==e&&"audience"!==e)throw E.error("[setRole] Invalid role."),new Error("Invalid role");"audience"===e&&this._hasPublished&&this.unpublish((function(){E.debug("[setRole] unpublish success.")}),(function(){throw E.error("[setRole] unpublish failure."),new Error("[setRole] unpublish failure.")})),this.role="broadcaster"===e?"Host":"Audience",null===(r=this._ws)||void 0===r||r.setClientRole(this.role).then((function(){t&&t()})).catch((function(e){n&&n(e)}))},t.prototype.subscribe=function(e,t,n){var r;if("string"!=typeof e||""===e)throw E.error("[subscribe] Invalid uid."),new Error("Invalid uid");var o=this.remoteUser.find((function(t){return t.uid===e}));if(!o)throw n&&n(),E.error("[subscribe] Can't find remote user"+e),new Error("Can't find remote user"+e);if(o.hasSub)throw n&&n(),E.error("[subscribe] You have subscribed to the user "+e+" media stream"),new Error("You have subscribed to the user "+e+" media stream");null===(r=this._ws)||void 0===r||r.doSubscribe(e,this.channelName).then((function(e){o.hasSub=!0,t&&t(e)})).catch((function(e){n&&n(e)}))},t.prototype.unmute=function(e,t,n,r){var o;if("string"!=typeof e||""===e)throw E.error("[unmute] Invalid uid."),new Error("Invalid uid");if("video"!==t&&"audio"!==t&&"all"!==t)throw E.error("[unmute] Invalid target."),new Error("Invalid target");var i=this.remoteUser.find((function(t){return t.uid===e}));if(!i)throw r&&r(),E.error("[unmute] Can't find remote user"+e),new Error("Can't find remote user"+e);if(!i.hasSub)throw r&&r(),E.error("[unmute] You haven't subscribed to this user's media yet."),new Error("You haven't subscribed to this user's media yet");var s=i.muteVideo,a=i.muteAudio;if(!i.hasVideo&&!i.hasAudio||"video"===t&&i.hasVideo&&!s||"audio"===t&&i.hasAudio&&!a||"all"===t&&!a&&!s)return E.error("[unmute] Invalid operation, The user's ("+e+t+")  alreadly unmute"),void(r&&r());switch(t){case"video":s&&(s=!1);break;case"audio":a&&(a=!1);break;case"all":a&&(a=!1),s&&(s=!1)}i.muteVideo=s,i.muteAudio=a,null===(o=this._ws)||void 0===o||o.doMuteRemoteStream(e,a,s),n&&n()},t.prototype.unmuteLocal=function(e,t,n){var r;if("CONNECTED"!==this._state)throw E.error("[unmuteLocal] Invalid Operational, join before unmuteLocal please."),new Error("Invalid Operational, join before unmuteLocal please");if(!this._hasPublished)throw E.error("[unmuteLocal] You haven't published the media stream."),new Error("You haven't published the media stream.");if("video"!==e&&"audio"!==e&&"all"!==e)throw E.error("[unmuteLocal] Invalid target."),new Error("Invalid target");if("video"===e&&this.enableVideo||"audio"===e&&this.enableAudio||"all"===e&&this.enableVideo&&this.enableAudio)n&&n();else{var o=!this.enableVideo,i=!this.enableAudio;switch(e){case"video":o&&(o=!1);break;case"audio":i&&(i=!1);break;case"all":i&&(i=!1),o&&(o=!1)}this.enableVideo=!o,this.enableAudio=!i,null===(r=this._ws)||void 0===r||r.doMuteLocalStream(i,o),t&&t()}},t.prototype.unpublish=function(e,t){var n,r=this;if("CONNECTED"!==r._state)throw new Error("Invalid Operational, join before unpublish please");if(!r._hasPublished)throw new Error("You haven't published the media stream.");null===(n=r._ws)||void 0===n||n.doUnPublish().then((function(){r._hasPublished=!1,e&&e()})).catch((function(e){t&&t(e)}))},t.prototype.unsubscribe=function(e,t,n){var r;if("string"!=typeof e||""===e)throw E.error("[unsubscribe] Invalid uid."),new Error("Invalid uid");var o=this.remoteUser.find((function(t){return t.uid===e}));if(!o)throw n&&n(),E.error("[unsubscribe] Can't find remote user"+e),new Error("Can't find remote user"+e);if(!o.hasSub)throw n&&n(),E.error("[unsubscribe] You have not subscribed the user "+e+" media stream"),new Error("You have not subscribed the user "+e+" media stream");null===(r=this._ws)||void 0===r||r.doUnSubscribe(e,this.channelName).then((function(){o.hasSub=!1,t&&t()})).catch((function(e){n&&n(e)}))},t.prototype.setParameters=function(e){return N(this,void 0,void 0,(function(){var t,n,r,o,i;return O(this,(function(a){return t=this,(n=e.ConfPriCloudAddr)&&(r=n.ServerAdd,o=n.Port,i=n.Wss,t._useWss="boolean"!=typeof i||i,r&&(s.GATEWAY_ADDRESS=t._useWss?"https://"+r:"http://"+r+(o?":"+o:""))),[2]}))}))},t.prototype._createMediaServerIntance=function(){var e=this;e._ws||(e._ws=new m,e._ws.handleMediaServerEvents=function(t,n){n.Code;switch(t){case"ConnectionStateChange":var r=n.curState;n.revState,n.reason;e._state=r;break;case"StreamAdded":n.ChanId;var o=n.UserId;e.remoteUser.push({uid:o,hasSub:!1,hasVideo:!0,hasAudio:!0,muteVideo:!1,muteAudio:!1}),e.emit("stream-added",{uid:o});break;case"StreamRemove":n.ChanId,o=n.UserId;for(var i=e.remoteUser.length-1;i>-1;i--){e.remoteUser[i].uid===o&&e.remoteUser.splice(i,1)}e.emit("stream-removed",{uid:o});break;case"UserAudStatus":n.ChanId,o=n.UserId;var s=n.Audio;(a=e.remoteUser.find((function(e){return e.uid===o}))).hasAudio=s,a.muteAudio=!s,s?e.emit("unmute-audio",{uid:o}):e.emit("mute-audio",{uid:o});break;case"UserVidStatus":n.ChanId,o=n.UserId;var a,u=n.Video;(a=e.remoteUser.find((function(e){return e.uid===o}))).hasVideo=u,a.muteVideo=!u,u?e.emit("unmute-video",{uid:o}):e.emit("mute-video",{uid:o})}})},t.prototype._authGateWay=function(e,t){var n;return N(this,void 0,void 0,(function(){var o,i,a,u,l,c;return O(this,(function(d){switch(d.label){case 0:return o=this,[4,r.joinGateway({sid:o._joinInfo.sid,appId:o._appId,cname:o.channelName,uid:e||"",token:t||"",extend:"",wss:o._useWss})];case 1:if(!(i=d.sent()))return[3,4];if(i.code,a=i.session_id,u=i.addresses,a&&(o._sessionId=a),!u||u instanceof Array&&0===u.length)throw E.error("Can not find service list."),new Error("Can not find service list");return[4,o._connectMediaServer(i)];case 2:return d.sent(),l={ChanId:o.channelName,ChanSId:o._sessionId,UserId:e,UserSId:o._joinInfo.sid,SdkVer:s.SDK_VERSION,SessionId:"",AcsToken:t||""},o._joinInfo.content=l,c=o,[4,null===(n=o._ws)||void 0===n?void 0:n.doJoin(l)];case 3:return c.uid=d.sent(),o._online=!0,o._joinInfo=g(g({},o._joinInfo),{apResponse:i,appId:o._appId,cname:o.channelName,uid:o.uid,turnServer:{},proxyServer:void 0,token:t||o._appId,useProxyServer:!1,startTime:Date.now()}),[2,o.uid];case 4:return[2,""]}}))}))},t.prototype._connectMediaServer=function(e){var t=this,n=e.addresses.filter((function(e){return 0===e.type}));return new Promise((function(e,r){var o,i,s;return N(this,void 0,void 0,(function(){var a,u,l,c,d,h;return O(this,(function(p){switch(p.label){case 0:if(!1,!(n.length>0))return[3,9];p.label=1;case 1:p.trys.push([1,6,7,8]),a=S(n),u=a.next(),p.label=2;case 2:return u.done?[3,5]:(l=u.value,null===(o=t._ws)||void 0===o||o.setAppInfo({appId:t._appId}),null===(i=t._ws)||void 0===i||i.configServer(t._useWss,l.addr,l.port),[4,null===(s=t._ws)||void 0===s?void 0:s.connectCTS()]);case 3:return p.sent(),e(),!0,[3,5];case 4:return u=a.next(),[3,2];case 5:return[3,8];case 6:return c=p.sent(),d={error:c},[3,8];case 7:try{u&&!u.done&&(h=a.return)&&h.call(a)}finally{if(d)throw d.error}return[7];case 8:return[3,10];case 9:throw r("CAN_NOT_GET_GATEWAY_SERVER"),E.error("Can not get gateway server."),new Error("CAN_NOT_GET_GATEWAY_SERVER");case 10:return[2]}}))}))}))},t}(u);t.default={client:I}}])}));